# -*- coding: utf-8 -*-# @Time : 2021/7/14 10:55# @Author : 孟艳红# @File : test_category.py 店铺分类import pytest,time,requests,chardet,json,yamlfrom API_project.Configs.shop_API import shopfrom API_project.Configs.Configuration import configuration_file# from data.text import# file = open(r"C:\Users\admin\PycharmProjects\API_project\data\text\areer.txt","r+")# # file.close()# file = file.read().encode('utf-8').decode('utf-8')# shopCategory=json.loads(file)# print(shopCategory)# with open(r"C:\Users\admin\PycharmProjects\API_project\data\text\areer.yaml") as f:#     yaml_data = yaml.safe_load(f)#     f.close()# shopCategory = shopCategor["data"]["shopDivision"]HOST = 'lxcrm' #设置测试环境 test:测试环境，staging:回归环境，lxcrm:正式环境shop = shop(HOST) #实例化店铺搜索shopCategory = configuration_file(HOST).shopDivision()#实例化店铺地区并返回配置信息province_list = []city_list = []district_list = []list_shenglen = len(shopCategory["normal"])for i in range(list_shenglen):    province_name = shopCategory["normal"][i]["NAME"]    province_value = shopCategory["normal"][i]["NUM"]    province_list.append((province_name,province_value))    list_shilen = len(shopCategory["normal"][i]["children"])    for j in range(list_shilen):        city_name = shopCategory["normal"][i]["children"][j]["NAME"]        city_value = shopCategory["normal"][i]["children"][j]["NUM"]        city_list.append((city_name,city_value))        list_qulen = len(shopCategory["normal"][i]["children"][j]["children"])        for q in range(list_qulen):            district_name = shopCategory["normal"][i]["children"][j]["children"][q]["NAME"]            district_value = shopCategory["normal"][i]["children"][j]["children"][q]["NUM"]            district_list.append((district_name,district_value))class Test_arer:    @pytest.mark.parametrize('province_name,province_value',province_list)    def test_province(self,province_name,province_value,ES):        es_client = ES        shopdata = shop.area_province(province_value)        time.sleep(2.5)        if shopdata['error_code'] != 0:            print(province_name,province_value)            assert shopdata['error_code'] == 0        if shopdata['data']['total'] != 0:            for i in range(len(shopdata['data']['items'])):                response_shop_id = shopdata['data']['items'][i]['id']                response_shop_name = shopdata['data']['items'][i]['name']                print(province_name, province_value)                print(response_shop_name, 'shop_id', response_shop_id)                try:                    es_result = es_client.get(index="shop_info_test_20210823", id=response_shop_id)['_source']  # 获取es搜索数据内容                except:                    print("ES调用失败")                    # print("ESget",es_result.request.body)                    pass                else:                    assert str(es_result["province"]) == str(province_value)        else:            print('\n搜索结果',shopdata)            print(province_name, province_value)            assert shopdata['data']['total'] != 0    @pytest.mark.parametrize('city_name,city_value', city_list)    def test_city(self,city_name,city_value,ES):#,,        print(city_name,city_value)        es_client = ES        shopdata = shop.area_city(city_value)        time.sleep(2.5)        if shopdata['error_code'] != 0:            print(city_name,city_value)            assert shopdata['error_code'] == 0        if shopdata['data']['total'] != 0:            for i in range(len(shopdata['data']['items'])):                response_shop_id = shopdata['data']['items'][i]['id']                response_shop_name = shopdata['data']['items'][i]['name']                print(city_name,city_value)                print(response_shop_name, 'shop_id', response_shop_id)                try:                    es_result = es_client.get(index="shop_info_test", id=response_shop_id)['_source']  # 获取es搜索数据内容                except:                    print("ES调用失败")                    pass                else:                    assert str(es_result["city"]) == str(city_value)        else:            print('\n搜索结果',shopdata)            print(city_name,city_value)            assert shopdata['data']['total'] != 0    @pytest.mark.parametrize('district_name,district_value', district_list)    def test_district(self,district_name,district_value,ES):        es_client = ES        shopdata = shop.area_district(district_value)        time.sleep(2.5)        if shopdata['error_code'] != 0:            print(district_name,district_value)            assert shopdata['error_code'] == 0        if shopdata['data']['total'] != 0:            for i in range(len(shopdata['data']['items'])):                response_shop_id = shopdata['data']['items'][i]['id']                response_shop_name = shopdata['data']['items'][i]['name']                print(district_name,district_value)                print(response_shop_name, 'shop_id', response_shop_id)                try:                    es_result = es_client.get(index="shop_info_test", id=response_shop_id)['_source']  # 获取es搜索数据内容                except:                    print("ES调用失败")                    pass                else:                    dis_list = es_result["district"]                    request_dis = district_value.split(",")                    len_district = [value for value in request_dis if value in dis_list]                    print(len_district)                    assert len_district != None                    assert len_district != []        else:            print('\n搜索结果',shopdata)            print(district_name,district_value)            assert shopdata['data']['total'] != 0    def test_p_c_d(self,ES):        es_client = ES        for i in range(list_shenglen):            province_name = shopCategory["normal"][i]["NAME"]            province_value = shopCategory["normal"][i]["NUM"]            list_shilen = len(shopCategory["normal"][i]["children"])            for j in range(list_shilen):                city_name = shopCategory["normal"][i]["children"][j]["NAME"]                city_value = shopCategory["normal"][i]["children"][j]["NUM"]                list_qulen = len(shopCategory["normal"][i]["children"][j]["children"])                for q in range(list_qulen):                    district_name = shopCategory["normal"][i]["children"][j]["children"][q]["NAME"]                    district_value = shopCategory["normal"][i]["children"][j]["children"][q]["NUM"]                    print(province_name, province_value)                    print(city_name, city_value)                    print(district_name, district_value)                    shopdata = shop.area_district(district_value)                    time.sleep(2.5)                    if shopdata['error_code'] != 0:                        assert shopdata['error_code'] == 0                    if shopdata['data']['total'] != 0:                        for i in range(len(shopdata['data']['items'])):                            response_shop_id = shopdata['data']['items'][i]['id']                            response_shop_name = shopdata['data']['items'][i]['name']                            print(response_shop_name, 'shop_id', response_shop_id)                            try:                                es_result = es_client.get(index="shop_info_test", id=response_shop_id)[                                    '_source']  # 获取es搜索数据内容                            except:                                print("ES调用失败")                            else:                                dis_list = es_result["district"]                                es_city = es_result["city"]                                es_province = es_result["province"]                                request_dis = district_value.split(",")                                len_district = [value for value in request_dis if value in dis_list]                                print("ES结果,province:"+es_province+"city:"+es_city+"district:"+dis_list)                                assert len_district != []                                assert str(es_city) == str(city_value)                                assert str(es_province) == str(province_value)                    else:                        print('\n搜索结果', shopdata)                        print(district_name, district_value)                        assert shopdata['data']['total'] != 0